terraform_prompt = """
As an experienced AWS cloud infrastructure engineer, you need to generate a production-ready Terraform configuration for a multi-environment setup. Use the details below to inform the architecture and settings:

**User Goal:** {{requirements}}  
**Services to Include:** {{services}}  
**Networking:** VPC CIDR = {{vpc_cidr}}, Subnet setup = {{subnet_configuration}}, Availability Zones = {{availability_zones}}  
**Compute:** {{compute_type}} (Multi-AZ = {{is_multi_az}}, Serverless = {{is_serverless}}) with a **{{load_balancer_type}}** load balancer if applicable  
**Features:** Logging = {{enable_logging}}, Monitoring = {{enable_monitoring}}, WAF = {{enable_waf}}  
**Tags:** {{tags}}  
**Database:** {{database_type}} (if applicable)  
**Custom Params:** {{custom_parameters}}  
**Region:** {{region}}

Using these parameters, **create Terraform code** for AWS that covers three environments: development (dev), staging (stage), and production (prod). The configuration should use a **modular design** and adhere to AWS best practices:

- **Modules and Reusability:** Define separate Terraform modules for each major component/service listed (and any additional components inferred from the requirements). For example, create modules for networking (VPC/subnets), compute (based on the given compute_type, e.g., EC2, ECS, EKS, or Lambda), databases (according to database_type), and other services like load balancers or WAF. These modules should encapsulate the resource definitions and use variables to allow configuration per environment.
- **Environment Configurations:** For each environment (dev, stage, prod), provide a Terraform configuration (e.g., a main.tf in an environment-specific folder) that **uses the modules**. In those environment files, use `module` blocks with `source = "../../modules/<module_name>"` to instantiate resources from the modules, passing in environment-specific values (such as different names, instance counts, or sizes). This ensures each environment is deploying a consistent architecture with appropriate differences where needed (for example, prod might have more instances or larger instance types than dev).
- **Networking & Architecture:** Implement a VPC and subnets according to the given CIDR and subnet layout. Ensure **public subnets** for externally facing resources (like load balancers) and **private subnets** for internal resources (application servers, databases). If a database tier is needed, include dedicated **database subnets** with no direct internet access. If `is_multi_az` is true, spread subnets and resources across multiple availability zones for high availability (and use multi-AZ features for services like RDS if using a relational database). Include necessary routing (Internet Gateway for public subnets, NAT Gateways for private subnets to reach the internet, etc.) and security groups following best practices (restrict traffic to necessary ports and sources).
- **Security Best Practices:** Use least privilege IAM roles and policies for each service. For example, if using EC2 or ECS, create IAM roles with only the permissions required for the application (and allow pulling from ECR if needed); if using Lambda, restrict its IAM role to what it needs (e.g., access to specific AWS services). Enable encryption for all data at rest (encrypt EBS volumes, enable RDS encryption, use SSE for S3 buckets, etc.) and enforce encryption in transit (HTTPS for web endpoints, TLS for database connections). If `enable_waf` is true, include an AWS WAF WebACL and associate it with the load balancer or API Gateway to protect web traffic.
- **Logging and Monitoring:** If logging is enabled, set up logging resources such as CloudWatch Log Groups for application logs, enable VPC Flow Logs, and configure S3 or CloudWatch Logs for load balancer access logs. If monitoring is enabled, create CloudWatch Alarms for key metrics (CPU utilization, memory, error rates, etc.) and possibly a CloudWatch Dashboard or SNS notifications for alerts. You may also include AWS CloudTrail and Config if comprehensive monitoring/auditing is desired (not mandatory but mention if relevant).
- **Compute and Scaling:** Depending on `{{compute_type}}` and `{{is_serverless}}`, set up the compute resources:
  - If the compute is EC2 or uses servers (not serverless): use an Auto Scaling Group for EC2 instances or an ECS cluster with EC2 launch type. Attach the specified type of load balancer (e.g., an ALB for web traffic) in front of these instances/containers. Configure launch templates or configurations for EC2 with appropriate instance types and security groups. Include auto-scaling policies (scale out/in based on load) to ensure high availability and scalability.
  - If the compute is serverless (e.g., Lambda or Fargate): configure AWS Lambda functions (along with an API Gateway or ALB trigger if needed for HTTP access) or an ECS Fargate service. Ensure the Lambda or Fargate tasks are set up with proper IAM roles and environment variables (for example, database connection info or other settings). For Lambda, consider concurrency limits or Provisioned Concurrency if needed; for Fargate/ECS, use AWS Application Auto Scaling to scale task count.
- **Database Setup:** If a database service is required (e.g., RDS or DynamoDB based on `{{database_type}}`), include it in the configuration:
  - For RDS/Aurora: deploy an instance or cluster in the private/database subnets, enable multi-AZ if `is_multi_az` is true, and set allocated storage, instance class, engine version as appropriate. Ensure the database is not publicly accessible, and security groups allow access only from the application instances or Lambda. Use Terraform variables for credentials and consider storing them in AWS Secrets Manager. 
  - For DynamoDB: create the table with the specified settings (throughput or on-demand capacity) and ensure the application IAM role has permission to read/write to this table.
- **Autoscaling & Secrets Management:** Include **autoscaling** for relevant components (as mentioned for EC2 ASG, ECS, or Lambda). Use **AWS Secrets Manager or SSM Parameter Store** for managing sensitive data such as database credentials or API keys. For example, if RDS is used, do not hard-code the password in Terraform; instead, generate or reference a secret from Secrets Manager, and allow the application (via its IAM role) to retrieve it. Include any necessary Terraform resources to create and reference these secrets.
- **Use of Terraform Features:** Leverage **data sources** to fetch any necessary existing information (e.g., `aws_ssm_parameter` data source to get AMI IDs or `aws_availability_zones` data source to list AZs) instead of hardcoding values where possible. Use **count** and **for_each** to simplify resource creation for repetitive resources (for instance, create multiple subnets or NAT Gateways by iterating rather than writing each one explicitly).
- **Tagging and Metadata:** Apply the provided tags uniformly across all resources. Additionally, tag resources with the environment name (env = dev/stage/prod) and any other useful metadata (like project name from requirements) to aid in identification. Use naming conventions in resources (like prefixing resource names with the environment or project name) to clearly distinguish environments.
- **Output Requirements:** The final output should be the **full Terraform code** in HCL format, organized by modules and environment files. For clarity, separate different file contents with comments or headings (for example, you can denote the start of each module file and each environment file). Include all necessary Terraform files (such as `variables.tf` and `outputs.tf` within modules if needed, and main config files for each environment). **Provide inline comments** in the code to explain any assumptions or to highlight values that may need to be adjusted (e.g., placeholder values or example IP addresses). Do not include any narrative explanation outside of the code itself.

Using these guidelines, **generate the Terraform configuration** for the dev, stage, and prod environments with the specified services and settings.
"""